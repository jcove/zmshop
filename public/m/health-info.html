<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>健康资讯</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--标准mui.css-->
		<script src="js/use-rem.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" href="css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="css/reset.css" />
		<!--App自定义的css-->
		<link rel="stylesheet" type="text/css" href="css/main.css" />
	</head>

	<body>
		<div id="healthInfo" class="comment health-info" style="height: 100%;">
			<header class="mui-bar mui-bar-nav bgwhite">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
				<h1 class="mui-title">{{pageTitle[language]}}</h1>
			</header>
			<div id="pullrefresh" class="mui-content mui-scroll-wrapper" style="height: 100%;">
				<div class="mui-scroll">
					<!--数据列表-->
					<ul class="mui-table-view mui-table-view-chevron">
						<li v-for="item in news" class="mui-row msgbox" @tap="linkToInfoDetails(item.link)">
							<div class="x-col3">
								<div class="imgbox" :style="{backgroundImage: 'url('+item.img+')'}"></div>
							</div>
							<div class="x-col9">
								<h5>{{item.title}}</h5><span>{{item.time}}</span>
								<p>{{item.content}}</p>
								<!--<p v-html="item.content"></p>-->
							</div>
						</li>
					</ul>
				</div>
			</div>
			<div id="startLoading" class="mui-loading" style="position: fixed;top: 0;left: 0;right: 0;bottom: 0;z-index: 2000;background-color: gainsboro;">
				<div class="mui-spinner" style="margin-top: 120px;width: 32px;height: 32px"></div>
			</div>
		</div>
		<script src="js/vue.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/axios.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui.min.js"></script>
		<script type="text/javascript">
			new Vue({
				el: '#healthInfo',
				data: {
					language: localStorage.choose,
					pageTitle: ['健康资讯', 'Health Info', '健康情報'],
					count: 0,
					news: [],
					page: 1,
					totalPage: 1,
					contentrefresh: ['正在加载...', 'loading...', 'ローディング中...'],
					contentnomore: ['没有更多数据了', "There's no more data", 'もっとデータがない。'],
				},
				mounted: function() {
					var that=this;
					document.getElementById('startLoading').style.display='none';
					mui.init({
						swipeBack: false,
						pullRefresh: {
							container: '#pullrefresh',
							up: {
								contentrefresh: that.contentrefresh[that.language],
								contentnomore: that.contentnomore[that.language],
								callback: this.pullupRefresh
							}
						}
					});
					var that = this;
					this.Axios = axios.create({
						baseURL: 'http://demo2.ruanwe.com/',
						timeout: 5000,
						headers: {
							'X-Requested-With': 'XMLHttpRequest'
						}
					});
					//获取文章列表
					this.Axios.get('api/article', {
						params: {
							page: 1
						}
					}).then(function(r) {
						console.log(r);
						if(r.data.data.length) {
							that.page = r.data.current_page;
							that.totalPage = r.data.last_page;
							console.log(that.page)
							console.log(that.totalPage)
							r.data.data.forEach(function(item) {
								that.news.push({
									img: item.cover,
									link: 'health-info-details.html?id=' + item.id,
									title: item.title,
									time: item.updated_at,
									content: item.content
								});
							});
						}
					}).catch(function(error) {
						console.log(error);
					});
				},
				methods: {
					linkToInfoDetails: function(href) {
						mui.openWindow({
							url: href,
							id: 'healthInfoDetails'
						});
					},
					pullupRefresh: function() {
						var that = this;
						setTimeout(function() {
							mui('#pullrefresh').pullRefresh().endPullupToRefresh((that.page === that.totalPage)); //参数为true代表没有更多数据了。
							if(that.page !== that.totalPage) {
								that.Axios.get('article/article', {
									params: {
										api_token: sessionStorage.user,
										page: that.page
									}
								}).then(function(r) {
									console.log(r);
									if(r.data.list.data.length) {
										that.page = r.data.list.current_page;
										that.totalPage = r.data.list.last_page;
										r.data.list.data.forEach(function(item) {
											that.news.push({
												img: item.cover,
												link: 'health-info-details.html?id=' + item.id,
												title: item.title,
												time: item.updated_at,
												content: item.content
											});
										});
									}
								}).catch(function(error) {
									console.log(error);
								});
							}
						}, 1500);
					}
				}
			});
		</script>
	</body>

</html>